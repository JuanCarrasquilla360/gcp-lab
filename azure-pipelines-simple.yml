# Azure Pipeline Simplificado para CI/CD a Google Cloud Run
# DiseÃ±ado para evitar limitaciones de paralelismo

trigger:
- main

variables:
  GCP_PROJECT_ID: 'deploy-php-461616'
  GCP_REGION: 'us-central1'
  SERVICE_NAME: 'helloworld-php-cicd'
  REGISTRY_HOSTNAME: 'gcr.io'
  IMAGE_NAME: '$(REGISTRY_HOSTNAME)/$(GCP_PROJECT_ID)/$(SERVICE_NAME)'

pool:
  vmImage: 'ubuntu-latest'

# Un solo stage con todos los pasos
jobs:
- job: BuildAndDeploy
  displayName: 'Test, Build and Deploy'
  steps:
  
  # Paso 1: Configurar PHP y ejecutar pruebas
  - script: |
      echo "ğŸ”§ Installing PHP..."
      sudo apt-get update -qq
      sudo apt-get install -y php php-cli
      php --version
    displayName: 'Setup PHP Environment'
  
  - script: |
      echo "ğŸ§ª Running PHP unit tests..."
      php test/test-app.php
    displayName: 'Run Unit Tests'
  
  # Paso 2: Mostrar archivos del proyecto
  - script: |
      echo "ğŸ“ Project structure:"
      ls -la
      echo "ğŸ“„ PHP application:"
      cat index.php
    displayName: 'Show Project Files'
  
  # Paso 3: Construir imagen Docker
  - task: Docker@2
    displayName: 'ğŸ³ Build Docker Image'
    inputs:
      command: 'build'
      Dockerfile: '**/Dockerfile'
      tags: |
        $(IMAGE_NAME):$(Build.BuildId)
        $(IMAGE_NAME):latest
  
  # Paso 4: Instalar Google Cloud SDK y desplegar
  - script: |
      set -e
      
      echo "â˜ï¸ Installing Google Cloud SDK..."
      curl -sSL https://sdk.cloud.google.com > /tmp/gcl && bash /tmp/gcl --install-dir=~/gcloud --disable-prompts
      export PATH="~/gcloud/google-cloud-sdk/bin:$PATH"
      
      echo "ğŸ” Authenticating with Google Cloud..."
      echo '$(GCP_SERVICE_ACCOUNT_KEY)' | base64 -d > /tmp/gcp-key.json
      ~/gcloud/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
      ~/gcloud/google-cloud-sdk/bin/gcloud config set project $(GCP_PROJECT_ID)
      
      echo "ğŸ³ Configuring Docker for GCR..."
      ~/gcloud/google-cloud-sdk/bin/gcloud auth configure-docker --quiet
      
      echo "ğŸ“¤ Pushing Docker image to GCR..."
      docker push $(IMAGE_NAME):$(Build.BuildId)
      docker push $(IMAGE_NAME):latest
      
      echo "ğŸš€ Deploying to Cloud Run..."
      ~/gcloud/google-cloud-sdk/bin/gcloud run deploy $(SERVICE_NAME) \
        --image $(IMAGE_NAME):$(Build.BuildId) \
        --platform managed \
        --region $(GCP_REGION) \
        --allow-unauthenticated \
        --port 80 \
        --memory 512Mi \
        --cpu 1000m \
        --max-instances 10 \
        --quiet
      
      echo "ğŸ” Getting service URL..."
      SERVICE_URL=$(~/gcloud/google-cloud-sdk/bin/gcloud run services describe $(SERVICE_NAME) --region=$(GCP_REGION) --format='value(status.url)')
      echo "âœ… Service deployed successfully!"
      echo "ğŸŒ Service URL: $SERVICE_URL"
      
      echo "ğŸ§ª Testing deployed service..."
      sleep 10
      response=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URL)
      if [ "$response" = "200" ]; then
        echo "âœ… Service is responding correctly!"
        echo "ğŸ‰ Deployment completed successfully!"
      else
        echo "âŒ Service test failed with HTTP $response"
        exit 1
      fi
      
      echo "ğŸ§¹ Cleaning up..."
      rm -f /tmp/gcp-key.json
      
    displayName: 'â˜ï¸ Deploy to Google Cloud Run'
    env:
      GCP_SERVICE_ACCOUNT_KEY: $(GCP_SERVICE_ACCOUNT_KEY)
  
  # Paso 5: Mostrar informaciÃ³n final
  - script: |
      echo ""
      echo "ğŸ‰ ============================================="
      echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
      echo "ğŸ‰ ============================================="
      echo ""
      echo "ğŸ“± Your application is now live at:"
      echo "ğŸŒ https://$(SERVICE_NAME)-[random-hash]-$(GCP_REGION).a.run.app"
      echo ""
      echo "ğŸ“Š Monitor your application:"
      echo "ğŸ–¥ï¸  Cloud Run Console: https://console.cloud.google.com/run"
      echo "ğŸ“ Logs: https://console.cloud.google.com/logs"
      echo "ğŸ“ˆ Metrics: https://console.cloud.google.com/monitoring"
      echo ""
      echo "ğŸ† Concepts demonstrated:"
      echo "âœ… Continuous Integration (CI)"
      echo "âœ… Continuous Deployment (CD)"
      echo "âœ… Containerization (Docker)"
      echo "âœ… Serverless Computing (Cloud Run)"
      echo "âœ… Infrastructure as Code (YAML)"
      echo ""
    displayName: 'ğŸ‰ Show Success Information' 